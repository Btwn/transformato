GOGOCREATE PROCEDURE [dbo].[xpValidarDevolucionMavi]@ID INT,@Ok INT OUTPUTAS BEGINDECLARE@ImporteDevolver MONEY,@Abono MONEY,@Referencia VARCHAR(50),@RefAnticipo VARCHAR(50),@MovAn VARCHAR(20),@MovIDAn VARCHAR(20),@MovP VARCHAR(20),@MovIDP VARCHAR(20),@Cuantos INT,@Iteracion INT,@AnticipoID INT,@ModuloID INT,@VentaID INT,@Bandera BITSELECT @Referencia = RefAnticipoMavi, @ImporteDevolver = (ISNULL(Importe,0.0)+ISNULL(Impuestos,0.0)) FROM Cxc WHERE ID=@IDSET @Bandera = 0SET @Abono = 0SET @AnticipoID = 0SET @ModuloID = 0SET @Iteracion = 1SET @Cuantos = (SELECT MAX(ID) FROM dbo.fnSplitMAVI(@Referencia,' '))SET @MovIDAn = (SELECT Item FROM dbo.fnSplitMAVI(@Referencia,' ') WHERE ID=@Cuantos)SET @Cuantos = (@Cuantos-1)SET @MovAn = ''WHILE @Iteracion <= @CuantosBEGINSET @MovAn = @MovAn+' '+(SELECT Item FROM dbo.fnSplitMavi(@Referencia,' ') WHERE ID=@Iteracion)SET @Iteracion = (@Iteracion+1)ENDSET @MovAn = LTRIM(@MovAn)SELECT @AnticipoID=ISNULL(ID,0), @ModuloID=ISNULL(ModuloID,0), @Abono=ISNULL(Abono,0), @RefAnticipo=Referencia FROM Anticipo WHERE Modulo='CXC' AND Mov=@MovAn AND MovID=@MovIDAn AND Cancelado = 0IF EXISTS (SELECT ID FROM Cxc WHERE Mov=@MovAn AND MovID=@MovIDAn AND Estatus='Concluido' AND dbo.fnClaveAfectacionMAVI(@MovAn, 'CXC') = 'CXC.AA')BEGINIF @ImporteDevolver>@AbonoSET @Ok = 100011ENDELSESET @Ok = 100012ENDGO